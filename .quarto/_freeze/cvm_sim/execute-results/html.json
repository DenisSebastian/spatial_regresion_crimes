{
  "hash": "ead0ab885baa0b87deda7b410b400f65",
  "result": {
    "markdown": "# CVM simulation {#cvm-sim}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Librer√≠as y Recursos ----------------------------------------------------\nsource(\"scripts/recursos.R\")\n\n\n# Funciones ---------------------------------------------------------------\nsource(\"scripts/funciones.R\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# List of crimes/delitos and cities/ciudades\ncrimes=c(\"Minor property offenses\",\"Robberies\",\"Burglaries\",\"Drunkennes, damages and disorders\",\n         \"Family violence and aggression\",\"Injuries, drugs and weapons\",\"High violence and murder\")\ndelitos = c(\"hurto\", \"robo\", \"asalto\", \"amen\", \"abus\", \"crim\", \"viol\")\n\ncities <- c(\"Coquimbo-Serena\")\nciudades <- c(\"urb_4_18\")\n\n## geographic projections\ncrs_latlon <- \"+proj=longlat +datum=WGS84 +no_defs\"\ncrs_utm <- \"+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0\"\n\n# Parameters\n  obs <- 1\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncity <- ciudades[obs] # city=ciudades[1]\n  cityp <- readRDS(paste0(\"data/\",city,\".rds\"))\n  cityp <- spTransform(cityp, CRS(crs_utm))\n  nb <- spatial_weights(city_df = cityp, nvec= 12)\n\n  \n  \ncityp <- cityp %>%\n  st_as_sf(crs = 4326) %>% \n  mutate(across(.cols = all_of(delitos),\n                .fns = t_cub, .names = \"cub{.col}\")) %>% \n  mutate(across(.cols = all_of(delitos),\n                .fns = t_log1p, .names = \"log{.col}\")) %>% \n  mutate(across(.cols = all_of(delitos),\n                .fns = lag_spatial, nb, .names = \"lag{.col}\")) %>%\n  as(\"Spatial\")\n\ndelito <-  delitos[1]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_mlb <- readRDS(paste0(\"output/mlb_\",city,\"_\",delito,\".rds\"))\nmlb_df <- predict_df(model = model_mlb, city = cityp, longlat = F)\n\n\nres_mlb <- mlb_df %>% \n  slice(sample(1:nrow(.), 100)) %>% \n  mutate(\n    cvm.sim = cvm_eval_spatial(coords_x = x, coords_y = y,\n                               var1 = delitos, var2 = ypred, \n                               nperm = nrow(.)-1))\n\n\n\n\nmodel_sar <- readRDS(paste0(\"output/sar_\",city,\"_\",delito,\".rds\"))\ndf_sar <- predict_df(model = model_mlb, city = cityp, longlat = F)\n\nres_sar <- df_sar %>% \n  slice(sample(1:nrow(.), 100)) %>% \n  mutate(\n    cvm.sim = cvm_eval_spatial(coords_x = x, coords_y = y,\n                               var1 = delitos, var2 = ypred, \n                               nperm = nrow(.)-1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nres_sar_sf <- st_as_sf(x = res_sar,                         \n                       coords = c(\"x\", \"y\"),\n                       crs = 4326)\n\nmapview::mapview(res_sar_sf, zcol =\"cvm.sim\") +\n  mapview::mapview(res_sar_sf, zcol =\"ypred_adj\")+\n  mapview::mapview(res_sar_sf, zcol =\"y_adj\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}