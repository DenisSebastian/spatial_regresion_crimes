{"title":"Diagnósticos de Residuos","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"console"}},"headingText":"Diagnósticos de Residuos","headingAttr":{"id":"d-residuos","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\noptions(scipen = 999)\nrequire(knitr)\nrequire(kableExtra)\n```\n\n## Pretratamientos de la Información\n\n#### Cargar Recursos Externos  {.unnumbered}\n\n```{r}\nsource(\"scripts/recursos.R\")\nsource(\"scripts/funciones.R\")\n```\n\n#### Definición de variables generales {.unnumbered}\n\n```{r}\n## geographic projections\ncrs_latlon <- \"+proj=longlat +datum=WGS84 +no_defs\"\ncrs_utm <- \n  \"+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0\"\n```\n\n#### Definición de variables específicas {.unnumbered}\n\n```{r}\n# List of crimes/delitos and cities/ciudades\ncrimes = c(\n  \"Minor property offenses\",\n  \"Robberies\",\n  \"Burglaries\",\n  \"Drunkennes, damages and disorders\",\n  \"Family violence and aggression\",\n  \"Injuries, drugs and weapons\",\n  \"High violence and murder\"\n)\ndelitos = c(\"hurto\", \"robo\", \"asalto\", \"amen\", \"abus\", \"crim\", \"viol\")\n\n#ciudad de ejemplo\ncities <- c(\"Coquimbo-Serena\")\nciudades <- c(\"urb_4_18\")\nobs <- 1\ndelito <- delitos[1]\n```\n\n<br>\n\n#### Lectura de Datos Espaciales {.unnumbered}\n\nPara el caso del presente ejemplo práctico se utiizará la ciudad de `r cities`.\n\n```{r warning=FALSE}\ncity <- ciudades[obs]\ncityp <- readRDS(paste0(\"data/\",city,\".rds\"))\ncityp <- spTransform(cityp, CRS(crs_utm))\n```\n\n\n\nEl objeto espacial `cityp` cuyos puntos corresponde donde ha ucurrido eventos deictuales, cuyo formato `SpatialPointDataFrame`. A continuación se visualizan  los delitos de `r delito`:\n\n\n```{r echo=FALSE}\nmapview(cityp %>% st_as_sf(), zcol = \"hurto\", cex = 3)\n```\n\n\n\n<br>\n\n*Matriz de vecindad espacial*: Se utilizó la función propia `spatial_weights()` @(sec-spatial-weights)\n\n\n```{r}\n# matriz de vecindad espacial\nnb <- spatial_weights(city_df = cityp, nvec= 12)\n\n```\n\n\n<br>\n\n####  Transformaciones a los datos. {.unnumbered}\n\nSe utilizó funciónes de transformacion general mencionadas en @sec-f-transform que corresponden a las siguientes:\n\n- Transformación Cúbica\n- Transformación Logarítmica\n- Cáculo del Lag Espacial\n\n\n```{r}\ncityp <- cityp %>%\n    st_as_sf(crs = 4326) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_cub, .names = \"cub{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_log1p, .names = \"log{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = lag_spatial, nb, .names = \"lag{.col}\")) %>%\n    as(\"Spatial\")\n```\n\n\n\n```{r echo=FALSE}\n\nkable_styling(\n  kable(cityp@data %>% head(10), digits = 3, row.names = FALSE, align = \"c\",\n              caption = NULL, format = \"html\"),\n        bootstrap_options = c(\"striped\", \"hover\", \"condensed\"),\n        position = \"center\", full_width = FALSE) \n\n\n```\n\n\n<br>\n\n\n##  Evaluación De Residuos\n\n### Modelos MLB \n\n####  Lectura del Modelo. {.unnumbered}\n\n\n```{r echo=FALSE}\ncity <- ciudades[obs] \ncityp <- readRDS(paste0(\"data/\",city,\".rds\"))\ncityp <- spTransform(cityp, CRS(crs_utm))\ncityp <- cityp %>%\n    st_as_sf(crs = 4326) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_cub, .names = \"cub{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_log1p, .names = \"log{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = lag_spatial, nb, .names = \"lag{.col}\")) %>%\n    as(\"Spatial\")\n```\n\n\n```{r}\nmodel_mlb <- readRDS(paste0(\"output/mlb_\",city,\"_\",delito,\".rds\"))\n```\n\n#### Extracción de Residuos\n\n```{r}\ncityp$res_fit_mlb <- residuals(model_mlb)\ncityp$fitted_fit_mlb <- fitted(model_mlb)\ncityp$sd_breaks_mlb <- scale(cityp$res_fit_mlb)[,1]\n\n\n```\n\n```{r warning=FALSE}\nbreaks_qt <- classInt::classIntervals(cityp$sd_breaks_mlb, \n                                      n = 5, style = \"fisher\")\nmy_breaks <- round(breaks_qt$brks,2)\n```\n\n```{r}\ncity_sf <- cityp %>% st_as_sf(crs = 32719) \n\nresiduos_mv <- mapview(city_sf,zcol=\"res_fit_mlb\", at =my_breaks, cex=2) \n  \n  \nresiduos_mv\n```\n\n#### Global Moran\n\nGlobal Moran a Variable Depediente \n\n```{r}\nspdep::moran.test(x = cityp$laghurto,  listw = nb)\n# moran.plot(x =cityp$laghurto,  listw = nb, labels=as.character(cityp$id))\n```\n\nGlobal Moran de Residuos\n\n```{r}\nspdep::moran.test(x = cityp$res_fit_mlb,  listw = nb)\n# moran.plot(x =cityp$res_fit_mlb,  listw = nb, labels=as.character(cityp$id))\n```\n\n#### Local Moran  de Residuos\n\n```{r}\n# Calcular Local Moran\nlmoran = localmoran(cityp$res_fit_mlb, nb)\n\ncityp$res_scaled = as.numeric(scale(cityp$res_fit_mlb))\ncityp$lag_scaled = lag.listw(nb, cityp$res_scaled)\ncityp@data = cbind(cityp@data, lmoran = as.data.frame(lmoran)[, 5])\n\n# Umbral de significancia estadistica\npval=0.05\n\n# Definir cuadrantes\ncityp[(cityp$res_scaled >= 0 & cityp$lag_scaled >= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"HH\" # plot\ncityp[(cityp$res_scaled <= 0 & cityp$lag_scaled <= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"LL\" # plot\ncityp[(cityp$res_scaled >= 0 & cityp$lag_scaled <= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"HL\"\ncityp[(cityp$res_scaled <= 0 & cityp$lag_scaled >= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"LH\"\ncityp[(lmoran[, 5] > pval), \"clusterM\"] = \"NS\"\ntable(cityp$clusterM)\n```\n\n\n```{r}\ncity_sf <- cityp %>% st_as_sf(crs = 32719) %>% \n  filter(clusterM != \"NS\")\n\nresiduos_moran <- mapview(city_sf,zcol=\"clusterM\", cex=2 )\nresiduos_moran\n```\n\n\n### Modelos SAR\n\n```{r echo=FALSE}\ncity <- ciudades[obs] \ncityp <- readRDS(paste0(\"data/\",city,\".rds\"))\ncityp <- spTransform(cityp, CRS(crs_utm))\ncityp <- cityp %>%\n    st_as_sf(crs = 4326) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_cub, .names = \"cub{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_log1p, .names = \"log{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = lag_spatial, nb, .names = \"lag{.col}\")) %>%\n    as(\"Spatial\")\n```\n\n\n\n```{r}\n\nmodel_sar <- readRDS(paste0(\"output/sar_\",city,\"_\",delito,\".rds\"))\n```\n\n\n#### Extracción de Residuos SAR\n```{r}\ncityp$res_fit_sar <- residuals(model_sar)\ncityp$fitted_fit_sar <- fitted(model_sar)\ncityp$sd_breaks_sar <- scale(cityp$res_fit_sar)[,1]\n\n\n```\n\n```{r warning=FALSE}\nbreaks_qt <- classInt::classIntervals(cityp$sd_breaks_sar, \n                                      n = 5, style = \"fisher\")\nmy_breaks <- round(breaks_qt$brks,2)\n```\n\n```{r}\ncity_sf <- cityp %>% st_as_sf(crs = 32719) \n\nresiduos_mv <- mapview(city_sf,zcol=\"res_fit_sar\", at =my_breaks, cex=2) \n  \nresiduos_mv\n```\n\n\n\n#### Global Moran\n\nGlobal Moran a Variable Depediente \n\n```{r}\nspdep::moran.test(x = cityp$cubhurto,  listw = nb)\n# moran.plot(x =cityp$laghurto,  listw = nb, labels=as.character(cityp$id))\n```\n\nGlobal Moran de Residuos\n\n```{r}\nspdep::moran.test(x = cityp$res_fit_sar,  listw = nb)\n# moran.plot(x =cityp$res_fit_mlb,  listw = nb, labels=as.character(cityp$id))\n```\n\n#### Local Moran  de Residuos\n\n```{r}\n# Calcular Local Moran\nlmoran = localmoran(cityp$res_fit_sar, nb)\n\ncityp$res_scaled = as.numeric(scale(cityp$res_fit_sar))\ncityp$lag_scaled = lag.listw(nb, cityp$res_scaled)\ncityp@data = cbind(cityp@data, lmoran = as.data.frame(lmoran)[, 5])\n\n# Umbral de significancia estadistica\npval=0.05\n\n# Definir cuadrantes\ncityp[(cityp$res_scaled >= 0 & cityp$lag_scaled >= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"HH\" # plot\ncityp[(cityp$res_scaled <= 0 & cityp$lag_scaled <= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"LL\" # plot\ncityp[(cityp$res_scaled >= 0 & cityp$lag_scaled <= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"HL\"\ncityp[(cityp$res_scaled <= 0 & cityp$lag_scaled >= 0) & (cityp$lmoran <= pval), \"clusterM\"] = \"LH\"\ncityp[(lmoran[, 5] > pval), \"clusterM\"] = \"NS\"\ntable(cityp$clusterM)\n```\n\n\n```{r}\ncity_sf <- cityp %>% st_as_sf(crs = 32719) %>% \n  filter(clusterM != \"NS\")\n\nresiduos_moran <- mapview(city_sf,zcol=\"clusterM\", cex=2 )\nresiduos_moran\n```\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"html_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"residuos.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.38","bibliography":["references.bib"],"theme":"cosmo","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"html_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"residuos.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"documentclass":"scrreprt","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{}}}}}