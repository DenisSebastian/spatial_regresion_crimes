{"title":"CVM ppp","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"console"}},"headingText":"CVM ppp","headingAttr":{"id":"cvm-ppp","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\noptions(scipen = 999)\nrequire(knitr)\nrequire(kableExtra)\n```\n\n## Pretratamientos de la Información\n\n#### Cargar Recursos Externos  {.unnumbered}\n\n```{r}\nsource(\"scripts/recursos.R\")\nsource(\"scripts/funciones.R\")\n```\n\n#### Definición de variables generales {.unnumbered}\n\n```{r}\n## geographic projections\ncrs_latlon <- \"+proj=longlat +datum=WGS84 +no_defs\"\ncrs_utm <- \n  \"+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0\"\n```\n\n#### Definición de variables específicas {.unnumbered}\n\n```{r}\n# List of crimes/delitos and cities/ciudades\ncrimes = c(\n  \"Minor property offenses\",\n  \"Robberies\",\n  \"Burglaries\",\n  \"Drunkennes, damages and disorders\",\n  \"Family violence and aggression\",\n  \"Injuries, drugs and weapons\",\n  \"High violence and murder\"\n)\ndelitos = c(\"hurto\", \"robo\", \"asalto\", \"amen\", \"abus\", \"crim\", \"viol\")\n\n#ciudad de ejemplo\ncities <- c(\"Coquimbo-Serena\")\nciudades <- c(\"urb_4_18\")\nobs <- 1\ndelito <- delitos[1]\n```\n\n<br>\n\n#### Lectura de Datos Espaciales {.unnumbered}\n\nPara el caso del presente ejemplo práctico se utiizará la ciudad de `r cities`.\n\n```{r warning=FALSE}\ncity <- ciudades[obs]\ncityp <- readRDS(paste0(\"data/\",city,\".rds\"))\ncityp <- spTransform(cityp, CRS(crs_utm))\n```\n\n\n\nEl objeto espacial `cityp` cuyos puntos corresponde donde ha ucurrido eventos deictuales, cuyo formato `SpatialPointDataFrame`. A continuación se visualizan  los delitos de `r delito`:\n\n\n```{r echo=FALSE}\nmapview(cityp %>% st_as_sf(), zcol = \"hurto\", cex = 3)\n```\n\n\n\n<br>\n\n*Matriz de vecindad espacial*: Se utilizó la función propia `spatial_weights()` @(sec-spatial-weights)\n\n\n```{r}\n# matriz de vecindad espacial\nnb <- spatial_weights(city_df = cityp, nvec= 12)\n\n```\n\n<br>\n\n#### Ventana de Trabajo para  ppp (Point Pattern Plane) {.unnumbered}\n\nCrea un objeto de clase \"ppp\" que representa un conjunto de datos de patrones de puntos en el plano bidimensional. Por lo anterior, se debe crear una ventana de observación `w`.\n\n```{r}\n#make windows\n  ext <- raster::extent(cityp)\n  x_min <- ext[1] + 100\n  x_max <- ext[2] - 100\n  y_min <- ext[3] + 100\n  y_max <- ext[4] - 100\n  w <- as.owin(c(x_min,x_max, y_min, y_max))\n```\n\n<br>\n\n####  Transformaciones a los datos. {.unnumbered}\n\nSe utilizó funciónes de transformacion general mencionadas en @sec-f-transform que corresponden a las siguientes:\n\n- Transformación Cúbica\n- Transformación Logarítmica\n- Cáculo del Lag Espacial\n\n\n```{r}\ncityp <- cityp %>%\n    st_as_sf(crs = 4326) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_cub, .names = \"cub{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = t_log1p, .names = \"log{.col}\")) %>% \n    mutate(across(.cols = all_of(delitos),\n                  .fns = lag_spatial, nb, .names = \"lag{.col}\")) %>%\n    as(\"Spatial\")\n```\n\n\n\n```{r echo=FALSE}\n\nkable_styling(\n  kable(cityp@data %>% head(10), digits = 3, row.names = FALSE, align = \"c\",\n              caption = NULL, format = \"html\"),\n        bootstrap_options = c(\"striped\", \"hover\", \"condensed\"),\n        position = \"center\", full_width = FALSE) \n\n\n```\n\n\n<br>\n\n\n##  Evaluación Cramer Von Mises\n\n### Modelos MLB \n\nPara transformar los datos espaciales de los delitos y las predicciones de los modelos se utilizó la función propia `ppp_maker()` @sec-ppp-maker que retorna el objeto `ppp`.\n\n####  Lectura del Modelo. {.unnumbered}\n\n```{r}\nmodel_mlb <- readRDS(paste0(\"output/mlb_\",city,\"_\",delito,\".rds\"))\n```\n\n####  Transformaciones de las predicciones del modelo a ppp. {.unnumbered}\n\n```{r}\n\nppp_mbl_pred <- ppp_maker(model = model_mlb, city = cityp, \n                     delito = delito, ppp_predict = T, w = w)\n\nplot(density(ppp_mbl_pred, adjust=.25))\n```\n\n\n####  Transformaciones de los delitos reales a a ppp. {.unnumbered}\n\n```{r}\nppp_mbl <- ppp_maker(model = model_mlb, city = cityp, \n                          delito = delito, ppp_predict = F, w= w)\n\nplot(density(ppp_mbl, adjust=.25))\n```\n\n####   Evaluación `cdf.test.()` {.unnumbered}\n\n\n```{r}\ncvm_mlb <- cdf.test(ppp_mbl, as.im(ppp_mbl), test=\"cvm\")\nplot(cvm_mlb)\n```\n\n```{r}\nattr_model <- attr(cvm_mlb, which = \"frame\")\nim <- attr_model$values$Zimage \nr_mlb <- raster(im)\nproj4string(r_mlb)=crs_utm\nvalues(r_mlb) <- ifelse(values(r_mlb)==0, NA, values(r_mlb))\nplot(r_mlb)\n\n\n```\n\n\n```{r}\npred_mlb <- predict_df(model = model_mlb, city = cityp, longlat = F)\npred_mlb <- st_as_sf(x = pred_mlb,                         \n                       coords = c(\"x\", \"y\"),\n                       crs = 32719) %>% \n  filter(!is.na(delitos))\n\nmapview(r_mlb, na.color= NA)+\n  mapview(pred_mlb, zcol = \"ypred\",hide = TRUE,  cex = 2)+\n  mapview(pred_mlb, zcol = \"delitos\", hide = TRUE,  cex = 2)\n```\n\n\n### Modelos SAR\n\n\n\n```{r}\ncity <- ciudades[obs] \nmodel_sar <- readRDS(paste0(\"output/sar_\",city,\"_\",delito,\".rds\"))\n\nppp_sar_pred <- ppp_maker(model = model_sar, city = cityp, \n                            delito = delito, ppp_predict = T,\n                            w = w, nb = nb)\n  \nplot(density(ppp_sar_pred, adjust=.1))\n```\n\n\n```{r}\nppp_sar <- ppp_maker(model = model_sar, city = cityp, \n                       delito = delito, ppp_predict = F, \n                       w = w, nb = nb)\n  \nplot(density(ppp_sar, adjust=.25))\n```\n\n\n```{r}\n# st <- syrjala.test(ppp_mbl, ppp_mbl_pred, nsim = 999)\ncvm_sar <- cdf.test(ppp_sar, as.im(ppp_sar_pred), test=\"cvm\")\nplot(cvm_sar)\n```\n\n\n```{r}\nattr_model <- attr(cvm_sar, which = \"frame\")\nim <- attr_model$values$Zimage \nr_sar <- raster(im)\nproj4string(r_sar)=crs_utm\nvalues(r_sar) <- ifelse(values(r_sar)==0, NA, values(r_sar))\n# plot(r_sar)\n\n\n```\n\n\n```{r}\npred_sar <- predict_df(model = model_sar, city = cityp, longlat = F)\npred_sar <- st_as_sf(x = pred_sar,                         \n                       coords = c(\"x\", \"y\"),\n                       crs = 32719) %>% \n  filter(!is.na(delitos))\n\nmapview(r_sar, na.color= NA)+\n  mapview(pred_sar, zcol = \"ypred\",hide = TRUE,  cex = 2)+\n  mapview(pred_sar, zcol = \"delitos\", hide = TRUE,  cex = 2)\n  \n```\n\n\n\n\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"html_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"cvm_ppp.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.38","bibliography":["references.bib"],"theme":"cosmo","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"html_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"cvm_ppp.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"documentclass":"scrreprt","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{}}}}}